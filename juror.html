<!DOCTYPE html>
<html>
<title>Inverse Pictionary</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<style>
body,h1,h2,h3,h4,h5 {font-family: "Raleway", sans-serif}
.slidecontainer {
  width: 100%;
}

.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 25px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

</style>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>
<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>

<script>
  var firebaseConfig = {
    apiKey: "AIzaSyBHChQmjKz49_YfQ1P8L9G2BJaBQ98AGpY",
    authDomain: "inversepictionary.firebaseapp.com",
    databaseURL: "https://inversepictionary.firebaseio.com",
    projectId: "inversepictionary",
    storageBucket: "inversepictionary.appspot.com",
    messagingSenderId: "1019811222453",
    appId: "1:1019811222453:web:ddad05cd4d72b5a1673ffc",
    measurementId: "G-LDQH297677"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  var db = firebase.database();

  function sendDrawing(raw_image, description, user_ID, writer_link) {
    data = firebase.database().ref('Drawings/').push({
      "raw_image": raw_image,
      "description": description,
      "user_ID": user_ID,
      "score_list": {0:0},
      "writer_link": writer_link
    });

    return data.key
  }

  function updateScores(tag_drawing, tag_description, score) {
    ref = firebase.database().ref('Drawings/' + tag_drawing)
    ref.once("value", function(snapshot) {
      next = snapshot.val()["score_list"].length
      firebase.database().ref('Drawings/' + tag_drawing + '/score_list/' + next.toString()).set(score)
    });
    
    ref = firebase.database().ref('Descriptions/' + tag_description)
    ref.once("value", function(snapshot) {
      next = snapshot.val()["score_list"].length
      firebase.database().ref('Descriptions/' + tag_description + '/score_list/' + next.toString()).set(score)
    });
  }

  function updateImageIncrement(tag, index) {
    ref = firebase.database().ref('Images/' + tag)
    ref.once("value", function(snapshot) {
      next = snapshot.val()[index] + 1
      firebase.database().ref('Images/' + tag + "/" + index).set(next)
    });
  }

  function updateDrawingList(description_id, tag) {
    ref = firebase.database().ref('Descriptions/' + description_id)
    ref.once("value", function(snapshot) {
      next = snapshot.val()["drawer_list"].length
      firebase.database().ref('Descriptions/' + description_id + "/drawer_list/" + next).set(tag)
    });
  }

  async function getRandDescription(){

    ref = firebase.database().ref('Descriptions/')
    const snapshot =  await ref.once('value');
    var obj = snapshot.val()
    var keys   = Object.keys(obj);
    var lowest = Math.min.apply(null, keys.map(function(x) { return obj[x]["drawer_list"].length} ));
    var match  = keys.filter(function(y) { return obj[y]["drawer_list"].length === lowest });
    console.log(match)
    rand_description = match[Math.floor(Math.random()*match.length)]
    const snapshot2 =  await firebase.database().ref('Descriptions/' + rand_description).once('value');
    description_text = snapshot2.val()["description"]
    image_id = snapshot2.val()["image_ID"]

    return {"id": rand_description, "text": description_text, "image_id": image_id}
  }

  // Getting random image
  window.onload = async function() {
    const desc_info = await getRandDescription()
    console.log(desc_info)

    //when the document is finished loading, replace everything
    //between the <a ...> </a> tags with the value of splitText
    document.getElementById("description_text").innerHTML=desc_info["text"];
    document.getElementById("description_id").innerHTML=desc_info["id"];
    document.getElementById("image_id").innerHTML=desc_info["image_id"];
  }

  user_ID = "ME"

  function isCanvasBlank(canvas) {
        return !canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0);
    }

  function submit(){
    // Check if drawing isn't empty
    canvas = document.getElementById('myCanvas')
    if(isCanvasBlank(canvas)){
        window.alert("Canvas cannot be blank");
    }
    else{
        tag = sendDrawing(canvas.toDataURL(), document.getElementById("description_text").innerHTML, user_ID, document.getElementById("description_id").innerHTML)
        updateImageIncrement(document.getElementById("image_id").innerHTML, "drawing_count")
        updateDrawingList(document.getElementById("description_id").innerHTML, tag)
        window.alert("Drawing successfully uploaded");
        location.reload();
    }
  }

</script>


<body class="w3-light-grey">

<!-- w3-content defines a container for fixed size centered content, 
and is wrapped around the whole page content, except for the footer in this example -->
<div class="w3-content" style="max-width:1400px">

    
<!-- Grid -->
<div class="w3-row">

<!-- Rule Overview -->
<div class="w3-col l9">
    <!-- Header -->
    <header class="w3-container w3-center w3-padding-32"> 
        <h1><b>Inverse Pictionary - Juror</b></h1>
        <p>Welcome to <span class="w3-tag">...</span></p>
    </header>

    <!-- Requirements -->
    <div class="w3-card w3-margin w3-margin-top">
      <div class="w3-container w3-white">
        <h4><b>Rule Overwiew</b></h4>
        <h5>Last updated on <span class="w3-opacity">Jan 25, 2020</span></h5>
        <p>Mauris neque quam, fermentum ut nisl vitae, convallis maximus nisl. Sed mattis nunc id lorem euismod placerat. Vivamus porttitor magna enim, ac accumsan tortor cursus at. Phasellus sed ultricies mi non congue ullam corper. Praesent tincidunt sed
            tellus ut rutrum. Sed vitae justo condimentum, porta lectus vitae, ultricies congue gravida diam non fringilla. Mauris neque quam, fermentum ut nisl vitae, convallis maximus nisl. Sed mattis nunc id lorem euismod placerat. Vivamus porttitor magna enim, ac accumsan tortor cursus at. Phasellus sed ultricies mi non congue ullam corper. Praesent tincidunt sed
            tellus ut rutrum. Sed vitae justo condimentum, porta lectus vitae, ultricies congue gravida diam non fringilla. Mauris neque quam, fermentum ut nisl vitae, convallis maximus nisl. Sed mattis nunc id lorem euismod placerat. Vivamus porttitor magna enim, ac accumsan tortor cursus at. Phasellus sed ultricies mi non congue ullam corper. Praesent tincidunt sed
            tellus ut rutrum. Sed vitae justo condimentum, porta lectus vitae, ultricies congue gravida diam non fringilla. Mauris neque quam, fermentum ut nisl vitae, convallis maximus nisl. Sed mattis nunc id lorem euismod placerat. Vivamus porttitor magna enim, ac accumsan tortor cursus at. Phasellus sed ultricies mi non congue ullam corper. Praesent tincidunt sed
            tellus ut rutrum. Sed vitae justo condimentum, porta lectus vitae, ultricies congue gravida diam non fringilla.</p>    
      </div>
    </div><hr>
  
<!-- END Introduction Menu -->
</div>

<script>
    var animal_name = "Tiger";

    window.onload = function() {
       //when the document is finished loading, replace everything
       //between the <a ...> </a> tags with the value of splitText
   document.getElementById("animal_name").innerHTML=animal_name;
} 

</script>

<!-- Blog entries -->
<div class="w3-col l3 s12">
  <!-- Image Description Box -->
  <div class="w3-card-4 w3-margin w3-white">
    <img src="tiger.jpeg" alt="Animal" style="width:100%">
    <img src="tiger_drawing.png" alt="Animal" style="width:100%">
    <div class="w3-container">
        <h6><b><a id="animal_name"></a></b> - Rate the drawing (1-5):</h6>
        <div class="slidecontainer">
            <input type="range" min="1" max="5" value="3" class="slider" id="score">
        </div>

        <div class="w3-col m8 s12">
            <p><button class="w3-button w3-padding-large w3-white w3-border"><a href="jurortext.html"><b>Submit »</b></a></button></p>
            </div>
            <div class="w3-col m4 w3-hide-small">
            <p><span class="w3-right"><b>Rating  </b> <span class="w3-tag">0</span></span></p>
        </div>
    </div>
    </div>
  <hr>
<!-- END BLOG ENTRIES -->
</div>

<!-- END GRID -->
</div><br>

<!-- END w3-content -->
</div>

<!-- Footer -->
<footer class="w3-container w3-dark-grey w3-padding-32 w3-margin-top">
  <p>Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a></p>
</footer>

</body>
</html>